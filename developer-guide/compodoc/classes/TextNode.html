<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>@atlasmap/atlasmap-data-mapper documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">@atlasmap/atlasmap-data-mapper documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content class">
                   <div class="content-data">











<ol class="breadcrumb">
  <li>Classes</li>
  <li>TextNode</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/lib/atlasmap-data-mapper/models/expression.model.ts</code>
        </p>


            <p class="comment">
                <h3>Extends</h3>
            </p>
            <p class="comment">
                        <code><a href="../classes/ExpressionNode.html" target="_self" >ExpressionNode</a></code>
            </p>



            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Static</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#PREFIX">PREFIX</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#str">str</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                    <span class="modifier">Static</span>
                                <a href="#sequence">sequence</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#uuid">uuid</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#toHTML">toHTML</a>
                            </li>
                            <li>
                                <a href="#toText">toText</a>
                            </li>
                            <li>
                                <a href="#getUuid">getUuid</a>
                            </li>
                            <li>
                                    <span class="modifier">Abstract</span>
                                <a href="#toHTML">toHTML</a>
                            </li>
                            <li>
                                    <span class="modifier">Abstract</span>
                                <a href="#toText">toText</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(str: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="43" class="link-to-prism">src/app/lib/atlasmap-data-mapper/models/expression.model.ts:43</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>str</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="PREFIX"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                                <span class="modifier">Readonly</span>
                            PREFIX</b>
                            <a href="#PREFIX"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;expression-text-&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="43" class="link-to-prism">src/app/lib/atlasmap-data-mapper/models/expression.model.ts:43</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="str"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            str</b>
                            <a href="#str"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="45" class="link-to-prism">src/app/lib/atlasmap-data-mapper/models/expression.model.ts:45</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="sequence"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Protected</span>
                                <span class="modifier">Static</span>
                            sequence</b>
                            <a href="#sequence"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>0</code>
                        </td>
                    </tr>
                            <tr>
                                <td class="col-md-4">
                                    <div class="io-line">Inherited from         <code><a href="../classes/ExpressionNode.html" target="_self" >ExpressionNode</a></code>
</div>
                                </td>
                            </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in         <code><a href="../classes/ExpressionNode.html#source" target="_self" >ExpressionNode:26</a></code>
</div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="uuid"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Protected</span>
                            uuid</b>
                            <a href="#uuid"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                            <tr>
                                <td class="col-md-4">
                                    <div class="io-line">Inherited from         <code><a href="../classes/ExpressionNode.html" target="_self" >ExpressionNode</a></code>
</div>
                                </td>
                            </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in         <code><a href="../classes/ExpressionNode.html#source" target="_self" >ExpressionNode:27</a></code>
</div>
                            </td>
                        </tr>


            </tbody>
        </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="toHTML"></a>
                    <span class="name">
                        <b>
                            toHTML
                        </b>
                        <a href="#toHTML"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>toHTML()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="53"
                            class="link-to-prism">src/app/lib/atlasmap-data-mapper/models/expression.model.ts:53</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="toText"></a>
                    <span class="name">
                        <b>
                            toText
                        </b>
                        <a href="#toText"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>toText()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="49"
                            class="link-to-prism">src/app/lib/atlasmap-data-mapper/models/expression.model.ts:49</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUuid"></a>
                    <span class="name">
                        <b>
                            getUuid
                        </b>
                        <a href="#getUuid"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getUuid()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Inherited from         <code><a href="../classes/ExpressionNode.html" target="_self" >ExpressionNode</a></code>
</div>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <div class="io-line">Defined in         <code><a href="../classes/ExpressionNode.html#source" target="_self" >ExpressionNode:33</a></code>
</div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="toHTML"></a>
                    <span class="name">
                        <b>
                            <span class="modifier">Abstract</span>
                            toHTML
                        </b>
                        <a href="#toHTML"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>toHTML()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Inherited from         <code><a href="../classes/ExpressionNode.html" target="_self" >ExpressionNode</a></code>
</div>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <div class="io-line">Defined in         <code><a href="../classes/ExpressionNode.html#source" target="_self" >ExpressionNode:38</a></code>
</div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="toText"></a>
                    <span class="name">
                        <b>
                            <span class="modifier">Abstract</span>
                            toText
                        </b>
                        <a href="#toText"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>toText()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Inherited from         <code><a href="../classes/ExpressionNode.html" target="_self" >ExpressionNode</a></code>
</div>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <div class="io-line">Defined in         <code><a href="../classes/ExpressionNode.html#source" target="_self" >ExpressionNode:37</a></code>
</div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>





    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { ConfigModel } from &#x27;../models/config.model&#x27;;
import { ErrorHandlerService } from &#x27;../services/error-handler.service&#x27;;
import { MappedField, MappingModel } from &#x27;./mapping.model&#x27;;
import { Subject } from &#x27;rxjs&#x27;;

export class ExpressionUpdatedEvent {
  constructor(public node?: ExpressionNode, public offset?: number) {}
}

export abstract class ExpressionNode {
  protected static sequence &#x3D; 0;
  protected uuid;

  constructor(prefix: string) {
    this.uuid &#x3D; prefix + ExpressionNode.sequence++;
  }

  getUuid() {
    return this.uuid;
  }

  abstract toText(): string;
  abstract toHTML(): string;
}

export class TextNode extends ExpressionNode {

  static readonly PREFIX &#x3D; &#x27;expression-text-&#x27;;

  constructor(public str: string) {
    super(TextNode.PREFIX);
  }

  toText(): string {
    return this.str;
  }

  toHTML(): string {
    return &#x60;&lt;span id&#x3D;&quot;${this.uuid}&quot;&gt;${this.str.replace(/ /g, &#x27;&amp;nbsp;&#x27;)}&lt;/span&gt;&#x60;;
  }

}

export class FieldNode extends ExpressionNode {

  static readonly PREFIX &#x3D; &#x27;expression-field-&#x27;;

  constructor(private mapping: MappingModel, public field?: MappedField, private index?: number) {
    super(FieldNode.PREFIX);
    if (!field) {
      this.field &#x3D; mapping.getMappedFieldForIndex((index + 1).toString(), true);
    }
  }

  toText(): string {
    return &#x27;${&#x27; + (this.mapping.getIndexForMappedField(this.field) - 1) + &#x27;}&#x27;;
  }

  toHTML(): string {
    if (this.field &amp;&amp; this.field.field) {
      return &#x60;&lt;span contenteditable&#x3D;&quot;false&quot; id&#x3D;&quot;${this.uuid}&quot; title&#x3D;&quot;${this.field.field.docDef.name}:${this.field.field.path}&quot;
        class&#x3D;&quot;expressionFieldLabel label label-default&quot;&gt;${this.field.field.name}&lt;/span&gt;&#x60;;
    } else {
      return &#x60;&lt;span contenteditable&#x3D;&quot;false&quot; id&#x3D;&quot;${this.uuid}&quot;
        title&#x3D;&quot;Field index &#x27;${this.mapping.getIndexForMappedField(this.field) - 1}&#x27; is not available&quot;
        class&#x3D;&quot;expressionFieldLabel label label-danger&quot;&gt;N/A&lt;/span&gt;&#x60;;
    }
  }

}

export class ExpressionModel {
  expressionUpdatedSource &#x3D; new Subject&lt;ExpressionUpdatedEvent&gt;();
  expressionUpdated$ &#x3D; this.expressionUpdatedSource.asObservable();

  private _nodes: ExpressionNode[] &#x3D; [];
  private textCache &#x3D; &#x27;&#x27;;
  private htmlCache &#x3D; &#x27;&#x27;;

  constructor(private mapping: MappingModel, private cfg: ConfigModel) {}

  generateInitialExpression() {
    this.mapping.getUserMappedFields(true).forEach(f &#x3D;&gt; this.appendFieldNode(f));
  }

  get nodes(): ReadonlyArray&lt;ExpressionNode&gt; {
    return this._nodes;
  }

  getLastNodeIndex() {
    return this._nodes.length - 1;
  }

  getLastNode() {
    return this._nodes[this.getLastNodeIndex()];
  }

  getNode(nodeId?: string): any {
    if (!nodeId) {
      return this.getLastNode();
    }
    return this._nodes.find(n &#x3D;&gt; n.getUuid() &#x3D;&#x3D;&#x3D; nodeId);
  }

  setConfigModel(cfg: ConfigModel) {
    this.cfg &#x3D; cfg;
  }

  /**
   * Clear all text from the specified TextNode offset range or from the &#x27;@&#x27; to the end
   * of the text node if no node ID is specified.
   *
   * Return the new UUID position indicator string or null.
   *
   * @param nodeId
   * @param startOffset
   * @param endOffset
   */
  clearText(nodeId?: string, startOffset?: number, endOffset?: number): TextNode {
    let targetNode: TextNode;
    let targetNodeIndex &#x3D; 0;
    if (!nodeId) {
      const lastNode &#x3D; this.getLastNode();
      if (!(lastNode instanceof TextNode)) {
        return null;
      }
      const keyPos &#x3D; lastNode.str.indexOf(&#x27;@&#x27;);
      if (keyPos !&#x3D;&#x3D; -1) {
        targetNodeIndex &#x3D; this._nodes.indexOf(lastNode);
        targetNode &#x3D; lastNode;
        targetNode.str &#x3D; targetNode.str.substring(0, keyPos);
      }
    } else {
      const node &#x3D; this._nodes.find(n &#x3D;&gt; n.getUuid() &#x3D;&#x3D;&#x3D; nodeId);
      if (!(node instanceof TextNode) || !endOffset) {
        return null;
      }
      targetNode &#x3D; node;
      targetNodeIndex &#x3D; this._nodes.indexOf(targetNode);
      const cleanStr &#x3D; targetNode.str.replace(targetNode.str.substring(startOffset, endOffset), &#x27;&#x27;);
      targetNode.str &#x3D; cleanStr;
    }
    this.updateCache();
    this.expressionUpdatedSource.next();
    return targetNode;
  }

  /**
   * Insert text into expression at specified position. If nodeId is not specified,
   * it will be added to the end of expression. It parses the string
   * and insert a set of TextNode &amp; FieldNode if it contains field reference like ${0},
   * otherwise just one TextNode.
   * This emits ExpressionUpdatedEvent which contains the latest node and offset it
   * worked on, so that the subscriber can determine where to put the caret in
   * the expression input widget. If ExpressionUpdatedEvent is undefined, it means that
   * it worked on the end of the expression.
   * @param str string to insert
   * @param nodeId target node to insert the string
   * @param offset position offset in the target node to insert the string
   */
  insertText(str: string, nodeId?: string, offset?: number) {
    this.insertNodes(this.createNodesFromText(str), nodeId, offset);
  }

  /**
   * Insert an array of ExpressionNodes at the specified position. If insertPosition is
   * not specified the nodes will be appended to the end of the expression.
   * This emits an ExpressionUpdatedEvent which contains the latest node and offset it
   * worked on, so that the subscriber can determine where to put the caret in
   * the expression input widget. If ExpressionUpdatedEvent is undefined, it means that
   * it worked on the end of the expression.
   *
   * @param newNodes an array of ExpressionNode to add
   * @param insertPosition target node to insert the string
   * @param offset position offset in the target node to insert the string
   */
  insertNodes(newNodes: ExpressionNode[], insertPosition?: string, offset?: number) {

    // No position was specified - append to the end
    if (!insertPosition) {
      const last &#x3D; this.getLastNode();
      if (!last) {
        this._nodes.push(...newNodes);
      } else if (last instanceof TextNode &amp;&amp; newNodes[0] instanceof TextNode) {
        const lastTextNode &#x3D; last as TextNode;
        (last as TextNode).str +&#x3D; (newNodes[0] as TextNode).str;
        newNodes.splice(0, 1, last);
        this._nodes.splice(this.getLastNodeIndex(), 1, ...newNodes);
      } else if (last instanceof FieldNode &amp;&amp; newNodes[0] instanceof FieldNode) {
        this._nodes.splice(this.getLastNodeIndex(), 0, new TextNode(&#x27; + &#x27;), ...newNodes);
      } else {
        this._nodes.push(...newNodes);
      }
      this.updateCache();
      this.expressionUpdatedSource.next();
      return;
    }

    // Requires position handling
    const updatedEvent &#x3D; new ExpressionUpdatedEvent();
    const targetNode &#x3D; this._nodes.find(n &#x3D;&gt; n.getUuid() &#x3D;&#x3D;&#x3D; insertPosition);
    const targetNodeIndex &#x3D; this._nodes.indexOf(targetNode);

    if (targetNode instanceof TextNode) {
      if (offset &#x3D;&#x3D;&#x3D; undefined || offset &#x3D;&#x3D;&#x3D; null || offset &lt; 0) {
        offset &#x3D; targetNode.str.length;
      }
      const pre &#x3D; targetNode.str.substring(0, offset);
      const post &#x3D; targetNode.str.substring(offset);
      if (pre.length &gt; 0) {
        if (newNodes[0] instanceof TextNode) {
          targetNode.str &#x3D; pre + (newNodes[0] as TextNode).str;
          newNodes.splice(0, 1, targetNode);
        } else {
          targetNode.str &#x3D; pre;
          newNodes.splice(0, 0, targetNode);
        }
      }
      if (post.length &gt; 0) {
        const lastNewNodeIndex &#x3D; newNodes.length - 1;
        if (newNodes[lastNewNodeIndex] instanceof TextNode) {
          let mergedTextNode: TextNode;
          if (pre.length &gt; 0) {
            mergedTextNode &#x3D; newNodes[lastNewNodeIndex] as TextNode;
            mergedTextNode.str +&#x3D; post;
          } else {
            mergedTextNode &#x3D; targetNode;
            mergedTextNode.str &#x3D; (newNodes[lastNewNodeIndex]as TextNode).str + post;
          }
          newNodes.splice(lastNewNodeIndex, 1, mergedTextNode);
        } else {
          if (pre.length &gt; 0) {
            newNodes.push(new TextNode(post));
          } else {
            targetNode.str &#x3D; post;
            newNodes.push(targetNode);
          }
        }
      }
      this._nodes.splice(targetNodeIndex, 1, ...newNodes);
      const lastAddedIndex &#x3D; targetNodeIndex + newNodes.length - 1;
      if (this._nodes[lastAddedIndex] instanceof FieldNode
          &amp;&amp; this.nodes[lastAddedIndex + 1] instanceof FieldNode) {
        // insert a glue in between FieldNodes so that it won&#x27;t break syntax and caret can go into
        const space &#x3D; new TextNode(&#x27; + &#x27;);
        this._nodes.splice(lastAddedIndex + 1, 0, space);
        updatedEvent.node &#x3D; space;
        updatedEvent.offset &#x3D; 1;
      } else if (this._nodes[lastAddedIndex] instanceof FieldNode) {
        updatedEvent.node &#x3D; this._nodes[lastAddedIndex + 1];
        updatedEvent.offset &#x3D; 0;
      } else {
        updatedEvent.node &#x3D; this._nodes[lastAddedIndex];
        updatedEvent.offset &#x3D; (this._nodes[lastAddedIndex] as TextNode).str.length - post.length;
      }
      this.updateCache();
      this.expressionUpdatedSource.next(updatedEvent);
      return;
    }

    // targetNode is a FieldNode - insert the text before it if offset is 0, otherwise after it
    if (offset !&#x3D;&#x3D; 0 &amp;&amp; newNodes[0] instanceof FieldNode) {
      // insert a glue in between FieldNodes so that it won&#x27;t break syntax and caret can go into
      newNodes.splice(0, 0, new TextNode(&#x27; + &#x27;));
    }
    const nextNodeIndex &#x3D; offset &#x3D;&#x3D;&#x3D; 0 ? targetNodeIndex : targetNodeIndex + 1;
    const nextNode &#x3D; this._nodes[nextNodeIndex];
    if (nextNode instanceof TextNode &amp;&amp; newNodes[newNodes.length - 1] instanceof TextNode) {
      updatedEvent.offset &#x3D; (newNodes[newNodes.length - 1] as TextNode).str.length;
      nextNode.str &#x3D; (newNodes[newNodes.length - 1] as TextNode).str + (nextNode as TextNode).str;
      newNodes.pop();
      this._nodes.splice(nextNodeIndex, 1, ...newNodes);
      updatedEvent.node &#x3D; nextNode;
    } else if (nextNode instanceof FieldNode &amp;&amp; newNodes[newNodes.length - 1] instanceof FieldNode) {
      // insert a glue in between FieldNodes so that it won&#x27;t break syntax and caret can go into
      const space &#x3D; new TextNode(&#x27; + &#x27;);
      this._nodes.splice(nextNodeIndex, 0, ...newNodes, space);
      updatedEvent.node &#x3D; space;
      updatedEvent.offset &#x3D; 1;
    } else {
      this._nodes.splice(nextNodeIndex, 0, ...newNodes);
      if (nextNode instanceof TextNode) {
        updatedEvent.node &#x3D; nextNode;
        updatedEvent.offset &#x3D; 0;
      } else {
        updatedEvent.node &#x3D; newNodes[newNodes.length - 1];
        updatedEvent.offset &#x3D; (newNodes[newNodes.length - 1] as TextNode).str.length;
      }
    }
    this.updateCache();
    this.expressionUpdatedSource.next(updatedEvent);
  }

  removeToken(lastFieldRefRemoved: (removed: MappedField) &#x3D;&gt; void, tokenPosition?: string, offset?: number) {

    // No position was specified - append to the end
    if (!tokenPosition) {
      const last &#x3D; this.getLastNode();
      if (!last) {
        return;
      }
      if (last instanceof FieldNode) {
        const removed &#x3D; this._nodes.pop() as FieldNode;
        if (!this._nodes.find(n &#x3D;&gt; n instanceof FieldNode &amp;&amp; n.field &#x3D;&#x3D;&#x3D; removed.field)) {
          lastFieldRefRemoved(removed.field);
        }
      } else if (last instanceof TextNode) {
        if (last.str.length &gt; 0) {
          last.str &#x3D; last.str.substring(0, last.str.length - 1);
        } else {
          this._nodes.pop();
        }
      }
      this.updateCache();
      this.expressionUpdatedSource.next();
      return;
    }

    // Requires position handling
    let updatedEvent &#x3D; new ExpressionUpdatedEvent();
    let targetNode &#x3D; this._nodes.find(n &#x3D;&gt; n.getUuid() &#x3D;&#x3D;&#x3D; tokenPosition);
    let targetNodeIndex &#x3D; this._nodes.indexOf(targetNode);
    if (!targetNode || offset &#x3D;&#x3D;&#x3D; -1) {
      if (targetNodeIndex &lt; 1) {
        return;
      }
      targetNode &#x3D; this._nodes[--targetNodeIndex];
      offset &#x3D; targetNode instanceof TextNode ? (targetNode as TextNode).str.length : 1;
    }
    if (targetNode instanceof FieldNode) {
      const removed &#x3D; this._nodes.splice(targetNodeIndex, 1);
      const targetFieldNode: FieldNode &#x3D; removed[0] as FieldNode;
      if (!this._nodes.find(n &#x3D;&gt; n instanceof FieldNode &amp;&amp; n.field &#x3D;&#x3D;&#x3D; targetFieldNode.field)) {
        lastFieldRefRemoved(targetFieldNode.field);
      }
      if (this._nodes.length &gt; targetNodeIndex) {
        if (this._nodes[targetNodeIndex - 1] instanceof TextNode
            &amp;&amp; this._nodes[targetNodeIndex] instanceof TextNode) {
          const newOffset &#x3D; (this._nodes[targetNodeIndex - 1] as TextNode).str.length;
          (this._nodes[targetNodeIndex - 1] as TextNode).str
              +&#x3D; (this._nodes[targetNodeIndex] as TextNode).str;
          this._nodes.splice(targetNodeIndex, 1);
          updatedEvent.node &#x3D; this._nodes[targetNodeIndex - 1];
          updatedEvent.offset &#x3D; newOffset;
        } else if (this._nodes[targetNodeIndex - 1] instanceof FieldNode
            &amp;&amp; this._nodes[targetNodeIndex] instanceof FieldNode) {
          const glue &#x3D; new TextNode(&#x27; + &#x27;);
          this._nodes.splice(targetNodeIndex, 0, glue);
          updatedEvent.node &#x3D; glue;
          updatedEvent.offset &#x3D; 3;
        } else if (this._nodes[targetNodeIndex - 1] instanceof TextNode) {
          updatedEvent.node &#x3D; this._nodes[targetNodeIndex - 1];
          updatedEvent.offset &#x3D; (this._nodes[targetNodeIndex - 1] as TextNode).str.length;
        } else if (this._nodes[targetNodeIndex] instanceof TextNode) {
          updatedEvent.node &#x3D; this._nodes[targetNodeIndex];
          updatedEvent.offset &#x3D; 0;
        }
      } else {
        // end of line
        updatedEvent &#x3D; undefined;
      }
    } else {
      const targetString &#x3D; (targetNode as TextNode).str;
      (targetNode as TextNode).str &#x3D; offset &#x3D;&#x3D;&#x3D; 0 ? targetString.substr(1)
        : targetString.substring(0, offset) + targetString.substring(offset + 1);
      if ((targetNode as TextNode).str.length &#x3D;&#x3D;&#x3D; 0) {
        this.cfg.errorService.info(&#x27;At least one space is required between field references.&#x27;, null);
        return;
      }
      updatedEvent.node &#x3D; targetNode;
      updatedEvent.offset &#x3D; offset;
    }
    this.updateCache();
    this.expressionUpdatedSource.next(updatedEvent);
  }

  /**
   * Replace the content of the last text node with a substring terminating at the
   * specified index.
   *
   * @param index
   */
  clearToEnd(index: number): void {
    const last &#x3D; this.getLastNode();
    if (!(last instanceof TextNode)) {
      return;
    }
    last.str &#x3D; last.str.substring(0, index);
  }

  /**
   * Reflect mapped source fields to the field references in the expression.
   * Selected source fields are inserted into or appended to the expression,
   * and unselected source fields are removed from expression.
   *
   * @param mapping Corresponding MappingModel object
   */
  updateFieldReference(mapping: MappingModel, insertPosition?: string, offset?: number) {
    const mappedFields &#x3D; mapping.getUserMappedFields(true);
    const toAdd: MappedField[] &#x3D; [];
    const toRemove: MappedField[] &#x3D; [];
    let fieldNodes &#x3D; this._nodes.filter(n &#x3D;&gt; n instanceof FieldNode) as FieldNode[];

    // Remove the field from the expression if unmapped.
    for (const node of fieldNodes) {
      if (mappedFields.includes(node.field)) {
        continue;
      }
      const index &#x3D; this._nodes.indexOf(node);
      this._nodes.splice(index, 1);
      if (this._nodes.length &gt; index &amp;&amp; this._nodes[index - 1] instanceof TextNode
          &amp;&amp; this._nodes[index] instanceof TextNode) {
        (this._nodes[index - 1] as TextNode).str +&#x3D; (this._nodes[index] as TextNode).str;
        this._nodes.splice(index, 1);
      }
    }

    // Add the specified field into the expression - append if no insert position is specified.
    fieldNodes &#x3D; this._nodes.filter(n &#x3D;&gt; n instanceof FieldNode) as FieldNode[];
    for (const mfield of mappedFields) {
      if (!fieldNodes.find(n &#x3D;&gt; n.field &#x3D;&#x3D;&#x3D; mfield)) {
        if (insertPosition) {
          this.insertNodes([new FieldNode(this.mapping, mfield)], insertPosition, offset);
        } else {
          this.appendFieldNode(mfield);
        }
      }
    }
    this.updateCache();
    this.expressionUpdatedSource.next();
  }

  clear() {
    this._nodes &#x3D; [];
    this.updateCache();
    this.expressionUpdatedSource.next();
  }

  toText() {
    return this.textCache;
  }

  toHTML() {
    return this.htmlCache;
  }

  private updateCache() {
    let answer &#x3D; &#x27;&#x27;;
    this._nodes.forEach(node &#x3D;&gt; answer +&#x3D; node.toText());
    this.textCache &#x3D; answer;
    answer &#x3D; &#x27;&#x27;;
    this._nodes.forEach(node &#x3D;&gt; answer +&#x3D; node.toHTML());
    this.htmlCache &#x3D; answer;
  }

  private createNodesFromText(text: string): ExpressionNode[] {
    const answer &#x3D; [];
    let position &#x3D; -1;
    let fn &#x3D; null;

    while ((position &#x3D; text.search(/\$\{[0-9]+\}/)) !&#x3D;&#x3D; -1 ) {
      if (position !&#x3D;&#x3D; 0) {
        answer.push(new TextNode(text.substring(0, position)));
      }
      const index &#x3D; parseInt(text.substring(position + 2, text.indexOf(&#x27;}&#x27;)), 10);
      fn &#x3D; new FieldNode(this.mapping, null, index);
      if (fn.field &#x3D;&#x3D;&#x3D; null) {
        this.cfg.errorService.error(&#x27;Unable to map expression index to field node.&#x27;, index);
      } else {
        answer.push(fn);
      }
      text &#x3D; text.substring(text.indexOf(&#x27;}&#x27;) + 1);
    }
    if (text.length &gt; 0) {
      answer.push(new TextNode(text));
    }
    return answer;
  }

  private appendFieldNode(mfield: MappedField) {
    const lastNode &#x3D; this._nodes.pop();
    if (lastNode instanceof FieldNode) {
        this._nodes.push(lastNode, new TextNode(&#x27; + &#x27;));
    } else if (lastNode instanceof TextNode) {
      if (lastNode.str.length &#x3D;&#x3D;&#x3D; 0) {
        this._nodes.push(new TextNode(&#x27; + &#x27;));
      } else {
        this._nodes.push(lastNode);
      }
    }
    this._nodes.push(new FieldNode(this.mapping, mfield));
  }

}

</code></pre>
    </div>
</div>



                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'class';
            var COMPODOC_CURRENT_PAGE_URL = 'TextNode.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
